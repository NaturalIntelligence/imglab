<action-beenest>
    <div>
        <input onclick={fetchWorks} type="button" name="fetchWorksBtn" id="fetchWorksBtn" value="请求任务" />
        <input onclick={submitWork} type="button" name="submitWorkBtn" id="submitWorkBtn" value="提交" />
        <input onclick={cancelWork} type="button" name="cancelWorkBtn" id="cancelWorkBtn" value="放弃" />
    </div>
    <script>
        this.fetchWorks = function(e){
            if (Object.keys(labellingData).length === 0 && labellingData.constructor === Object) {

                var postData = {
                            type: "rect",
                            num: 4
                        };

                var instance = axiosClient();
                instance.post('/works/fetch', postData)
                .then(function(response) {
                        var works = response.data;
                        if (works.length > 0) {
                            works.forEach(function(v) {
                                var workId = v.id;
                                instance.get('/works/'+workId+'/file', {
                                    responseType: 'blob'
                                }).then(function(response) {
                                    readImageBlob(workId, response.data);
                                });
                            });                            
                        } else{
                            alert('暂时没有任务');
                        }
                })
                .catch(function (error) {
                    console.log(error);
                        alert('请求失败，请检查令牌是否有效。');
                });

            }

        }

        this.submitWork = function(e){

        	if (imgSelected.name) {

	        	var selectedImageName = imgSelected.name;
                console.log(imgSelected)
                var image = labellingData[ selectedImageName ];
                var labels = [];
		        for(var shape_i = 0 ; shape_i < image.shapes.length; shape_i++){
		        	// if (image.shapes.length !== 1) {
		        	// 	alert('只允许提交一个目标');
		        	// } else {
			            var shape = image.shapes[ shape_i ];
			            var labelData = [
				            {
				            	x: shape.bbox.x,
				            	y: shape.bbox.y
				            },
				            {
				            	x: shape.bbox.x + shape.bbox.w,
				            	y: shape.bbox.y + shape.bbox.h  //这边感觉写错了，应该是h
				            }
			            ];
                        labels.push(labelData);

		        	// }
		        }

                if (labels.length > 0) {
                    var instance = axiosClient();
                    instance.post('/works', {id: selectedImageName, result: labels})
                      .then(function(response) {
                            // console.log('submitted');
                            deleteAndNextImage(selectedImageName);
                      })
                      .catch(function (error) {
                        console.log(error);
                        // if (error.response.status === 403) {
                            clearAllImages();
                            alert('提交失败（任务超时或格式错误）');
                            console.log(error);
                        // }
                      });
                }

        	}

		}

		this.cancelWork = function(e) {

        	if (imgSelected.name) {

	        	var selectedImageName = imgSelected.name;
                
                var instance = axiosClient();

	            instance.delete('/works/' + selectedImageName + '/cancel')
	              .then(function(response) {
	                    // console.log('cancelled');
	                    deleteAndNextImage(selectedImageName);
	              })
	              .catch(function (error) {
	                console.log(error);
	              	// if (error.response.status === 403) {
	                    clearAllImages();
	              		// alert('Failed to submit');
	              		console.log(error);
	              	// }
	              });

          }

		}

    </script>
</action-beenest>